<script>
    let processedFiles = [];

    function handleFiles(files) {
        const statusList = document.getElementById('status-list');
        statusList.innerHTML = "<b>Processing...</b>"; 
        processedFiles = [];

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const srt = convertVTTtoSRT(e.target.result);
                processedFiles.push({ name: file.name.replace('.vtt', '.srt'), data: srt });
                
                // Visual Feedback: Add a manual download button for each file
                const row = document.createElement('div');
                row.className = 'file-row';
                row.innerHTML = `
                    <span>${file.name}</span>
                    <button onclick="downloadSingle(${processedFiles.length - 1})" 
                            style="background:#27ae60; color:white; border:none; border-radius:4px; padding:4px 8px;">
                        Save SRT
                    </button>`;
                statusList.appendChild(row);
            };
            reader.readAsText(file);
        });
    }

    function downloadSingle(index) {
        const file = processedFiles[index];
        downloadFile(file.data, file.name);
    }

    function convertVTTtoSRT(vtt) {
        [span_2](start_span)// Cleaning logic based on your uploaded files[span_2](end_span)
        return vtt
            .replace(/WEBVTT\n?/g, '')
            .replace(/NOTE .*\n/g, '')
            .replace(/(\d{2}:\d{2}:\d{2})\.(\d{3})/g, '$1,$2') 
            .replace(/(\d{2}:\d{2})\.(\d{3})/g, '00:$1,$2')
            .replace(/\/g, '') 
            .split(/\n\s*\n/)
            .filter(block => block.includes('-->'))
            .map((block, i) => `${i + 1}\n${block.trim()}\n`)
            .join('\n');
    }

    function downloadFile(data, filename) {
        const blob = new Blob([data], { type: 'text/srt' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link); // Required for some mobile browsers
        link.click();
        document.body.removeChild(link);
    }
</script>
